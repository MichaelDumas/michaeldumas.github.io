import GameEntity from"./GameEntity.js";import{context,DEBUG,images,sounds,timer}from"../globals.js";import StateMachine from"../../lib/StateMachine.js";import PlayerWalkingState from"../states/entity/player/PlayerWalkingState.js";import PlayerSwordSwingingState from"../states/entity/player/PlayerSwordSwingingState.js";import PlayerIdlingState from"../states/entity/player/PlayerIdlingState.js";import PlayerStateName from"../enums/PlayerStateName.js";import Hitbox from"../../lib/Hitbox.js";import ImageName from"../enums/ImageName.js";import Sprite from"../../lib/Sprite.js";import Room from"../objects/Room.js";import Direction from"../enums/Direction.js";import SoundName from"../enums/SoundName.js";import{getRandomNumber,getRandomPositiveInteger}from"../../lib/RandomNumberHelpers.js";import Equipement from"../abilities/Equipement.js";import Tile from"../objects/Tile.js";export default class Player extends GameEntity{static WIDTH=24;static HEIGHT=30;static BOUNDARY_DOWN=140;static BOUNDARY_UP=0;static BOUNDARY_LEFT=13;static BOUNDARY_RIGHT=324;static WALKING_SPRITE_WIDTH=48;static WALKING_SPRITE_HEIGHT=48;static SWORD_SWINGING_SPRITE_WIDTH=48;static SWORD_SWINGING_SPRITE_HEIGHT=48;static INVULNERABLE_DURATION=1;static INVULNERABLE_FLASH_INTERVAL=.1;static EQUIPMENT_DURATION=15;static EQUIPMENT_COOLDOWN=30;static BASE_ATTACK_SPEED=.15;static BOOTS_ATTACK_SPEED=.05;static BASE_SPEED=100;static BOOTS_SPEED=200;static BASE_ENEMIES_PER_LEVEL=10;static ARMOR_AMOUNT=6;static MAX_HEALTH=6;constructor(){super(),this.walkingSprites=Sprite.generateSpritesFromSpriteSheet(images.get(ImageName.PlayerWalkDown),Player.WALKING_SPRITE_WIDTH,Player.WALKING_SPRITE_HEIGHT),this.walkingSprites=this.walkingSprites.concat(Sprite.generateSpritesFromSpriteSheet(images.get(ImageName.PlayerWalkRight),Player.WALKING_SPRITE_WIDTH,Player.WALKING_SPRITE_HEIGHT)),this.walkingSprites=this.walkingSprites.concat(Sprite.generateSpritesFromSpriteSheet(images.get(ImageName.PlayerWalkUp),Player.WALKING_SPRITE_WIDTH,Player.WALKING_SPRITE_HEIGHT)),this.walkingSprites=this.walkingSprites.concat(Sprite.generateSpritesFromSpriteSheet(images.get(ImageName.PlayerWalkLeft),Player.WALKING_SPRITE_WIDTH,Player.WALKING_SPRITE_HEIGHT)),this.swordSwingingSprites=Sprite.generateSpritesFromSpriteSheet(images.get(ImageName.PlayerSwordDown),Player.WALKING_SPRITE_WIDTH,Player.WALKING_SPRITE_HEIGHT),this.swordSwingingSprites=this.swordSwingingSprites.concat(Sprite.generateSpritesFromSpriteSheet(images.get(ImageName.PlayerSwordRight),Player.WALKING_SPRITE_WIDTH,Player.WALKING_SPRITE_HEIGHT)),this.swordSwingingSprites=this.swordSwingingSprites.concat(Sprite.generateSpritesFromSpriteSheet(images.get(ImageName.PlayerSwordUp),Player.WALKING_SPRITE_WIDTH,Player.WALKING_SPRITE_HEIGHT)),this.swordSwingingSprites=this.swordSwingingSprites.concat(Sprite.generateSpritesFromSpriteSheet(images.get(ImageName.PlayerSwordLeft),Player.WALKING_SPRITE_WIDTH,Player.WALKING_SPRITE_HEIGHT)),this.idleSprites=Sprite.generateSpritesFromSpriteSheet(images.get(ImageName.PlayerIdleDown),Player.WALKING_SPRITE_WIDTH,Player.WALKING_SPRITE_HEIGHT),this.idleSprites=this.idleSprites.concat(Sprite.generateSpritesFromSpriteSheet(images.get(ImageName.PlayerIdleRight),Player.WALKING_SPRITE_WIDTH,Player.WALKING_SPRITE_HEIGHT)),this.idleSprites=this.idleSprites.concat(Sprite.generateSpritesFromSpriteSheet(images.get(ImageName.PlayerIdleUp),Player.WALKING_SPRITE_WIDTH,Player.WALKING_SPRITE_HEIGHT)),this.idleSprites=this.idleSprites.concat(Sprite.generateSpritesFromSpriteSheet(images.get(ImageName.PlayerIdleLeft),Player.WALKING_SPRITE_WIDTH,Player.WALKING_SPRITE_HEIGHT)),this.sprites=this.walkingSprites,this.positionOffset={x:0,y:0},this.swordHitbox=new Hitbox(0,0,0,0,"blue"),this.hitboxOffsets=new Hitbox(.75*Player.WIDTH,Player.HEIGHT,-Player.WIDTH/2,-.75*Player.HEIGHT),this.dimensions.x=Player.WIDTH,this.dimensions.y=Player.HEIGHT,this.speed=Player.BASE_SPEED,this.maxHealth=Player.MAX_HEALTH,this.totalHealth=this.maxHealth,this.health=this.maxHealth,this.isInvulnerable=!1,this.alpha=1,this.invulnerabilityTimer=null,this.stateMachine=this.initializeStateMachine(),this.level=0,this.enemiesPerLevel=Player.BASE_ENEMIES_PER_LEVEL,this.equipment=new Equipement,this.attackSpeed=Player.BASE_ATTACK_SPEED,this.chestplateActive=!1,this.chestplateDamageTaken=0,this.chestplateHealthAmount=Player.ARMOR_AMOUNT,this.roomShifting=!1,this.gameWon=!1,this.canRise=!1}render(){context.save(),context.globalAlpha=this.alpha,super.render(this.positionOffset),context.restore(),DEBUG&&this.swordHitbox.render(context)}reset(){this.position.x=Room.CENTER_X-Player.WALKING_SPRITE_WIDTH/2,this.position.y=Room.BOTTOM_EDGE-2*Tile.TILE_SIZE,this.level=0,this.maxHealth=Player.MAX_HEALTH,this.enemiesPerLevel=Player.BASE_ENEMIES_PER_LEVEL,this.health=Player.MAX_HEALTH,this.isDead=!1,this.gameWon=!1,this.isInvulnerable=!1,this.alpha=1,this.invulnerabilityTimer?.clear(),this.direction=Direction.Down,this.stateMachine.change(PlayerStateName.Idle),this.equipment.usable=!0,this.equipment.alpha=1,this.canRise=!1}initializeStateMachine(){const e=new StateMachine;return e.add(PlayerStateName.Walking,new PlayerWalkingState(this)),e.add(PlayerStateName.SwordSwinging,new PlayerSwordSwingingState(this)),e.add(PlayerStateName.Idle,new PlayerIdlingState(this)),e.change(PlayerStateName.Idle),e}receiveDamage(e){this.chestplateActive&&(this.chestplateDamageTaken+=e),this.health-=e,sounds.play(SoundName.HitPlayer)}becomeInvulnerable(){this.isInvulnerable=!0,this.invulnerabilityTimer=this.startInvulnerabilityTimer()}startInvulnerabilityTimer(){const e=Player.INVULNERABLE_FLASH_INTERVAL,t=Player.INVULNERABLE_DURATION;return timer.addTask((()=>{this.alpha=1===this.alpha?.5:1}),e,t,(()=>{this.alpha=1,this.isInvulnerable=!1}))}useFlashBoots(){this.attackSpeed=Player.BOOTS_ATTACK_SPEED,this.equipment.usable=!1,this.speed=Player.BOOTS_SPEED,timer.wait(Player.EQUIPMENT_DURATION,(()=>{this.attackSpeed=Player.BASE_ATTACK_SPEED,this.speed=Player.BASE_SPEED,this.equipment.alpha=.3,timer.wait(Player.EQUIPMENT_COOLDOWN,(()=>{this.equipment.usable=!0,this.equipment.alpha=1}))}))}useMerlinPotion(){this.health!=this.maxHealth&&(this.health=this.maxHealth,this.equipment.alpha=.3,timer.wait(Player.EQUIPMENT_COOLDOWN,(()=>{this.equipment.usable=!0,this.equipment.alpha=1})))}useChestPlate(){this.maxHealth=this.maxHealth+this.chestplateHealthAmount,this.health+=this.chestplateHealthAmount,this.chestplateDamageTaken=0,this.chestplateActive=!0,this.equipment.usable=!1,this.equipment.alpha=.3,timer.wait(Player.EQUIPMENT_DURATION,(()=>{this.maxHealth=this.maxHealth-this.chestplateHealthAmount,this.health-=this.chestplateHealthAmount-(this.chestplateDamageTaken<this.chestplateHealthAmount?this.chestplateDamageTaken:this.chestplateHealthAmount),timer.wait(Player.EQUIPMENT_COOLDOWN,(()=>{this.equipment.usable=!0,this.equipment.alpha=1}))}))}}