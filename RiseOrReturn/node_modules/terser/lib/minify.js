"use strict";import{defaults,map_from_object,map_to_object,HOP}from"./utils/index.js";import{AST_Toplevel,AST_Node}from"./ast.js";import{parse}from"./parse.js";import{OutputStream}from"./output.js";import{Compressor}from"./compress/index.js";import{base54}from"./scope.js";import{SourceMap}from"./sourcemap.js";import{mangle_properties,mangle_private_properties,reserve_quoted_keys}from"./propmangle.js";var to_ascii="undefined"==typeof atob?function(e){return Buffer.from(e,"base64").toString()}:atob,to_base64="undefined"==typeof btoa?function(e){return Buffer.from(e).toString("base64")}:btoa;function read_source_map(e){var r=/(?:^|[^.])\/\/# sourceMappingURL=data:application\/json(;[\w=-]*)?;base64,([+/0-9A-Za-z]*=*)\s*$/.exec(e);return r?to_ascii(r[2]):(console.warn("inline source map not found"),null)}function set_shorthand(e,r,a){r[e]&&a.forEach((function(a){r[a]&&("object"!=typeof r[a]&&(r[a]={}),e in r[a]||(r[a][e]=r[e]))}))}function init_cache(e){e&&("props"in e?e.props instanceof Map||(e.props=map_from_object(e.props)):e.props=new Map)}function cache_to_json(e){return{props:map_to_object(e.props)}}async function minify(e,r){var a,o,s=(r=defaults(r,{compress:{},ecma:void 0,enclose:!1,ie8:!1,keep_classnames:void 0,keep_fnames:!1,mangle:{},module:!1,nameCache:null,output:null,format:null,parse:{},rename:void 0,safari10:!1,sourceMap:!1,spidermonkey:!1,timings:!1,toplevel:!1,warnings:!1,wrap:!1},!0)).timings&&{start:Date.now()};if(void 0===r.keep_classnames&&(r.keep_classnames=r.keep_fnames),void 0===r.rename&&(r.rename=r.compress&&r.mangle),r.output&&r.format)throw new Error("Please only specify either output or format option, preferrably format.");if(r.format=r.format||r.output||{},set_shorthand("ecma",r,["parse","compress","format"]),set_shorthand("ie8",r,["compress","mangle","format"]),set_shorthand("keep_classnames",r,["compress","mangle"]),set_shorthand("keep_fnames",r,["compress","mangle"]),set_shorthand("module",r,["parse","compress","mangle"]),set_shorthand("safari10",r,["mangle","format"]),set_shorthand("toplevel",r,["compress","mangle"]),set_shorthand("warnings",r,["compress"]),r.mangle&&(r.mangle=defaults(r.mangle,{cache:r.nameCache&&(r.nameCache.vars||{}),eval:!1,ie8:!1,keep_classnames:!1,keep_fnames:!1,module:!1,nth_identifier:base54,properties:!1,reserved:[],safari10:!1,toplevel:!1},!0),r.mangle.properties&&("object"!=typeof r.mangle.properties&&(r.mangle.properties={}),r.mangle.properties.keep_quoted&&(a=r.mangle.properties.reserved,Array.isArray(a)||(a=[]),r.mangle.properties.reserved=a),r.nameCache&&!("cache"in r.mangle.properties)&&(r.mangle.properties.cache=r.nameCache.props||{})),init_cache(r.mangle.cache),init_cache(r.mangle.properties.cache)),r.sourceMap&&(r.sourceMap=defaults(r.sourceMap,{asObject:!1,content:null,filename:null,includeSources:!1,root:null,url:null},!0)),s&&(s.parse=Date.now()),e instanceof AST_Toplevel)o=e;else{if(("string"==typeof e||r.parse.spidermonkey&&!Array.isArray(e))&&(e=[e]),r.parse=r.parse||{},r.parse.toplevel=null,r.parse.spidermonkey)r.parse.toplevel=AST_Node.from_mozilla_ast(Object.keys(e).reduce((function(r,a){return r?(r.body=r.body.concat(e[a].body),r):e[a]}),null));else for(var t in delete r.parse.spidermonkey,e)if(HOP(e,t)&&(r.parse.filename=t,r.parse.toplevel=parse(e[t],r.parse),r.sourceMap&&"inline"==r.sourceMap.content)){if(Object.keys(e).length>1)throw new Error("inline source map only works with singular input");r.sourceMap.content=read_source_map(e[t])}o=r.parse.toplevel}a&&"strict"!==r.mangle.properties.keep_quoted&&reserve_quoted_keys(o,a),r.wrap&&(o=o.wrap_commonjs(r.wrap)),r.enclose&&(o=o.wrap_enclose(r.enclose)),s&&(s.rename=Date.now()),s&&(s.compress=Date.now()),r.compress&&(o=new Compressor(r.compress,{mangle_options:r.mangle}).compress(o)),s&&(s.scope=Date.now()),r.mangle&&o.figure_out_scope(r.mangle),s&&(s.mangle=Date.now()),r.mangle&&(o.compute_char_frequency(r.mangle),o.mangle_names(r.mangle),o=mangle_private_properties(o,r.mangle)),s&&(s.properties=Date.now()),r.mangle&&r.mangle.properties&&(o=mangle_properties(o,r.mangle.properties)),s&&(s.format=Date.now());var n={};if(r.format.ast&&(n.ast=o),r.format.spidermonkey&&(n.ast=o.to_mozilla_ast()),!HOP(r.format,"code")||r.format.code){if(r.sourceMap&&(r.format.source_map=await SourceMap({file:r.sourceMap.filename,orig:r.sourceMap.content,root:r.sourceMap.root}),r.sourceMap.includeSources)){if(e instanceof AST_Toplevel)throw new Error("original source content unavailable");for(var t in e)HOP(e,t)&&r.format.source_map.get().setSourceContent(t,e[t])}delete r.format.ast,delete r.format.code,delete r.format.spidermonkey;var p=OutputStream(r.format);if(o.print(p),n.code=p.get(),r.sourceMap)if(r.sourceMap.asObject?n.map=r.format.source_map.get().toJSON():n.map=r.format.source_map.toString(),"inline"==r.sourceMap.url){var m="object"==typeof n.map?JSON.stringify(n.map):n.map;n.code+="\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,"+to_base64(m)}else r.sourceMap.url&&(n.code+="\n//# sourceMappingURL="+r.sourceMap.url)}return r.nameCache&&r.mangle&&(r.mangle.cache&&(r.nameCache.vars=cache_to_json(r.mangle.cache)),r.mangle.properties&&r.mangle.properties.cache&&(r.nameCache.props=cache_to_json(r.mangle.properties.cache))),r.format&&r.format.source_map&&r.format.source_map.destroy(),s&&(s.end=Date.now(),n.timings={parse:.001*(s.rename-s.parse),rename:.001*(s.compress-s.rename),compress:.001*(s.scope-s.compress),scope:.001*(s.mangle-s.scope),mangle:.001*(s.properties-s.mangle),properties:.001*(s.format-s.properties),format:.001*(s.end-s.format),total:.001*(s.end-s.start)}),n}export{minify,to_ascii};