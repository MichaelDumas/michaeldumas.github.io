"use strict";import{defaults,push_uniq}from"./utils/index.js";import{base54}from"./scope.js";import{AST_Binary,AST_Call,AST_ClassPrivateProperty,AST_Conditional,AST_Dot,AST_DotHash,AST_ObjectKeyVal,AST_ObjectProperty,AST_PrivateMethod,AST_PrivateGetter,AST_PrivateSetter,AST_Sequence,AST_String,AST_Sub,TreeTransformer,TreeWalker}from"./ast.js";import{domprops}from"../tools/domprops.js";function find_builtins(e){domprops.forEach(n);var t={},r="object"==typeof global?global:self;function n(t){e.add(t)}["Symbol","Map","Promise","Proxy","Reflect","Set","WeakMap","WeakSet"].forEach((function(e){t[e]=r[e]||new Function})),["null","true","false","NaN","Infinity","-Infinity","undefined"].forEach(n),[Object,Array,Function,Number,String,Boolean,Error,Math,Date,RegExp,t.Symbol,ArrayBuffer,DataView,decodeURI,decodeURIComponent,encodeURI,encodeURIComponent,eval,EvalError,Float32Array,Float64Array,Int8Array,Int16Array,Int32Array,isFinite,isNaN,JSON,t.Map,parseFloat,parseInt,t.Promise,t.Proxy,RangeError,ReferenceError,t.Reflect,t.Set,SyntaxError,TypeError,Uint8Array,Uint8ClampedArray,Uint16Array,Uint32Array,URIError,t.WeakMap,t.WeakSet].forEach((function(e){Object.getOwnPropertyNames(e).map(n),e.prototype&&Object.getOwnPropertyNames(e.prototype).map(n)}))}function reserve_quoted_keys(e,t){function r(e){push_uniq(t,e)}e.walk(new TreeWalker((function(e){e instanceof AST_ObjectKeyVal&&e.quote?r(e.key):e instanceof AST_ObjectProperty&&e.quote?r(e.key.name):e instanceof AST_Sub&&addStrings(e.property,r)})))}function addStrings(e,t){e.walk(new TreeWalker((function(e){return e instanceof AST_Sequence?addStrings(e.tail_node(),t):e instanceof AST_String?t(e.value):e instanceof AST_Conditional&&(addStrings(e.consequent,t),addStrings(e.alternative,t)),!0})))}function mangle_private_properties(e,t){var r=-1,n=new Map,a=t.nth_identifier||base54;return e=e.transform(new TreeTransformer((function(e){e instanceof AST_ClassPrivateProperty||e instanceof AST_PrivateMethod||e instanceof AST_PrivateGetter||e instanceof AST_PrivateSetter?e.key.name=o(e.key.name):e instanceof AST_DotHash&&(e.property=o(e.property))})));function o(e){let t=n.get(e);return t||(t=a.get(++r),n.set(e,t)),t}}function mangle_properties(e,t){var r=(t=defaults(t,{builtins:!1,cache:null,debug:!1,keep_quoted:!1,nth_identifier:base54,only_cache:!1,regex:null,reserved:null,undeclared:!1},!0)).nth_identifier,n=t.reserved;Array.isArray(n)||(n=[n]);var a=new Set(n);t.builtins||find_builtins(a);var o,i=-1;o=t.cache?t.cache.props:new Map;var s,f=t.regex&&new RegExp(t.regex),c=!1!==t.debug;c&&(s=!0===t.debug?"":t.debug);var p=new Set,u=new Set;o.forEach((e=>u.add(e)));var l=!!t.keep_quoted;return e.walk(new TreeWalker((function(e){if(e instanceof AST_ClassPrivateProperty||e instanceof AST_PrivateMethod||e instanceof AST_PrivateGetter||e instanceof AST_PrivateSetter||e instanceof AST_DotHash);else if(e instanceof AST_ObjectKeyVal)"string"!=typeof e.key||l&&e.quote||d(e.key);else if(e instanceof AST_ObjectProperty)l&&e.quote||d(e.key.name);else if(e instanceof AST_Dot){var r=!!t.undeclared;if(!r){for(var n=e;n.expression;)n=n.expression;r=!(n.thedef&&n.thedef.undeclared)}!r||l&&e.quote||d(e.property)}else e instanceof AST_Sub?l||addStrings(e.property,d):e instanceof AST_Call&&"Object.defineProperty"==e.expression.print_to_string()?addStrings(e.args[1],d):e instanceof AST_Binary&&"in"===e.operator&&addStrings(e.left,d)}))),e.transform(new TreeTransformer((function(e){e instanceof AST_ClassPrivateProperty||e instanceof AST_PrivateMethod||e instanceof AST_PrivateGetter||e instanceof AST_PrivateSetter||e instanceof AST_DotHash||(e instanceof AST_ObjectKeyVal?"string"!=typeof e.key||l&&e.quote||(e.key=y(e.key)):e instanceof AST_ObjectProperty?l&&e.quote||(e.key.name=y(e.key.name)):e instanceof AST_Dot?l&&e.quote||(e.property=y(e.property)):!l&&e instanceof AST_Sub?e.property=A(e.property):e instanceof AST_Call&&"Object.defineProperty"==e.expression.print_to_string()?e.args[1]=A(e.args[1]):e instanceof AST_Binary&&"in"===e.operator&&(e.left=A(e.left)))})));function S(e){return!u.has(e)&&(!a.has(e)&&(t.only_cache?o.has(e):!/^-?[0-9]+(\.[0-9]+)?(e[+-][0-9]+)?$/.test(e)))}function _(e){return!(f&&!f.test(e))&&(!a.has(e)&&(o.has(e)||p.has(e)))}function d(e){S(e)&&p.add(e),_(e)||u.add(e)}function y(e){if(!_(e))return e;var t=o.get(e);if(!t){if(c){var n="_$"+e+"$"+s+"_";S(n)&&(t=n)}if(!t)do{t=r.get(++i)}while(!S(t));o.set(e,t)}return t}function A(e){return e.transform(new TreeTransformer((function(e){if(e instanceof AST_Sequence){var t=e.expressions.length-1;e.expressions[t]=A(e.expressions[t])}else e instanceof AST_String?e.value=y(e.value):e instanceof AST_Conditional&&(e.consequent=A(e.consequent),e.alternative=A(e.alternative));return e})))}}export{reserve_quoted_keys,mangle_properties,mangle_private_properties};