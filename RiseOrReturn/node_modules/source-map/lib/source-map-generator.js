const base64VLQ=require("./base64-vlq"),util=require("./util"),ArraySet=require("./array-set").ArraySet,MappingList=require("./mapping-list").MappingList;class SourceMapGenerator{constructor(e){e||(e={}),this._file=util.getArg(e,"file",null),this._sourceRoot=util.getArg(e,"sourceRoot",null),this._skipValidation=util.getArg(e,"skipValidation",!1),this._sources=new ArraySet,this._names=new ArraySet,this._mappings=new MappingList,this._sourcesContents=null}static fromSourceMap(e){const n=e.sourceRoot,t=new SourceMapGenerator({file:e.file,sourceRoot:n});return e.eachMapping((function(e){const o={generated:{line:e.generatedLine,column:e.generatedColumn}};null!=e.source&&(o.source=e.source,null!=n&&(o.source=util.relative(n,o.source)),o.original={line:e.originalLine,column:e.originalColumn},null!=e.name&&(o.name=e.name)),t.addMapping(o)})),e.sources.forEach((function(o){let i=o;null!==n&&(i=util.relative(n,o)),t._sources.has(i)||t._sources.add(i);const r=e.sourceContentFor(o);null!=r&&t.setSourceContent(o,r)})),t}addMapping(e){const n=util.getArg(e,"generated"),t=util.getArg(e,"original",null);let o=util.getArg(e,"source",null),i=util.getArg(e,"name",null);this._skipValidation||this._validateMapping(n,t,o,i),null!=o&&(o=String(o),this._sources.has(o)||this._sources.add(o)),null!=i&&(i=String(i),this._names.has(i)||this._names.add(i)),this._mappings.add({generatedLine:n.line,generatedColumn:n.column,originalLine:null!=t&&t.line,originalColumn:null!=t&&t.column,source:o,name:i})}setSourceContent(e,n){let t=e;null!=this._sourceRoot&&(t=util.relative(this._sourceRoot,t)),null!=n?(this._sourcesContents||(this._sourcesContents=Object.create(null)),this._sourcesContents[util.toSetString(t)]=n):this._sourcesContents&&(delete this._sourcesContents[util.toSetString(t)],0===Object.keys(this._sourcesContents).length&&(this._sourcesContents=null))}applySourceMap(e,n,t){let o=n;if(null==n){if(null==e.file)throw new Error('SourceMapGenerator.prototype.applySourceMap requires either an explicit source file, or the source map\'s "file" property. Both were omitted.');o=e.file}const i=this._sourceRoot;null!=i&&(o=util.relative(i,o));const r=this._mappings.toArray().length>0?new ArraySet:this._sources,s=new ArraySet;this._mappings.unsortedForEach((function(n){if(n.source===o&&null!=n.originalLine){const o=e.originalPositionFor({line:n.originalLine,column:n.originalColumn});null!=o.source&&(n.source=o.source,null!=t&&(n.source=util.join(t,n.source)),null!=i&&(n.source=util.relative(i,n.source)),n.originalLine=o.line,n.originalColumn=o.column,null!=o.name&&(n.name=o.name))}const l=n.source;null==l||r.has(l)||r.add(l);const u=n.name;null==u||s.has(u)||s.add(u)}),this),this._sources=r,this._names=s,e.sources.forEach((function(n){const o=e.sourceContentFor(n);null!=o&&(null!=t&&(n=util.join(t,n)),null!=i&&(n=util.relative(i,n)),this.setSourceContent(n,o))}),this)}_validateMapping(e,n,t,o){if(n&&"number"!=typeof n.line&&"number"!=typeof n.column)throw new Error("original.line and original.column are not numbers -- you probably meant to omit the original mapping entirely and only map the generated position. If so, pass null for the original mapping instead of an object with empty or null values.");if(e&&"line"in e&&"column"in e&&e.line>0&&e.column>=0&&!n&&!t&&!o);else if(!(e&&"line"in e&&"column"in e&&n&&"line"in n&&"column"in n&&e.line>0&&e.column>=0&&n.line>0&&n.column>=0&&t))throw new Error("Invalid mapping: "+JSON.stringify({generated:e,source:t,original:n,name:o}))}_serializeMappings(){let e,n,t,o,i=0,r=1,s=0,l=0,u=0,a=0,c="";const g=this._mappings.toArray();for(let p=0,h=g.length;p<h;p++){if(n=g[p],e="",n.generatedLine!==r)for(i=0;n.generatedLine!==r;)e+=";",r++;else if(p>0){if(!util.compareByGeneratedPositionsInflated(n,g[p-1]))continue;e+=","}e+=base64VLQ.encode(n.generatedColumn-i),i=n.generatedColumn,null!=n.source&&(o=this._sources.indexOf(n.source),e+=base64VLQ.encode(o-a),a=o,e+=base64VLQ.encode(n.originalLine-1-l),l=n.originalLine-1,e+=base64VLQ.encode(n.originalColumn-s),s=n.originalColumn,null!=n.name&&(t=this._names.indexOf(n.name),e+=base64VLQ.encode(t-u),u=t)),c+=e}return c}_generateSourcesContent(e,n){return e.map((function(e){if(!this._sourcesContents)return null;null!=n&&(e=util.relative(n,e));const t=util.toSetString(e);return Object.prototype.hasOwnProperty.call(this._sourcesContents,t)?this._sourcesContents[t]:null}),this)}toJSON(){const e={version:this._version,sources:this._sources.toArray(),names:this._names.toArray(),mappings:this._serializeMappings()};return null!=this._file&&(e.file=this._file),null!=this._sourceRoot&&(e.sourceRoot=this._sourceRoot),this._sourcesContents&&(e.sourcesContent=this._generateSourcesContent(e.sources,e.sourceRoot)),e}toString(){return JSON.stringify(this.toJSON())}}SourceMapGenerator.prototype._version=3,exports.SourceMapGenerator=SourceMapGenerator;